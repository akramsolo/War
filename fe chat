--[[
    Ù†Ø¸Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† - Ù†Ø³Ø®Ø© Ù…Ø³ØªÙ‚Ø±Ø© ÙˆØ®ÙÙŠÙØ© "Pro"
    - Ø£Ø³Ù„ÙˆØ¨ Ø­Ø¯ÙŠØ«: TextChatService (RBXGeneral:SendAsync)
    - ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ø§Ø¨ØªØ© (ØªØ¸Ù‡Ø±/ØªÙØ®ÙÙ‰ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù/Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ù†Ø´Ø§Ø¡)
    - Ø¯Ù…Ø¬ Ø£ÙÙƒØ§Ø± Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø£Ù†Ù…Ø§Ø· Ø¹Ø±Ø¶ ÙƒØ«ÙŠØ±Ø© + ØªÙˆØ³Ø¹Ø© Ø¹Ø¨Ø± GUI)
    - Ø®ÙØ© ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¶Ø­Ø© + RNG Ø­ØªÙ…ÙŠ Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    - ØªÙ†Ø¸ÙŠÙ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… + Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±Ø§Øª + ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    - Ù„Ø§ ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…ÙˆØ§Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…Ø§Ø¨
]]--

----------------------------
-- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© --
----------------------------
if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players            = game:GetService("Players")
local TextChatService    = game:GetService("TextChatService")
local StarterGui         = game:GetService("StarterGui")

local localPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- Ø§Ù„Ù‚Ù†Ø§Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ø­Ø¯ÙŠØ«Ø©
local function getGeneralChannel()
    local ok, ch = pcall(function()
        local channels = TextChatService:WaitForChild("TextChannels")
        return channels:WaitForChild("RBXGeneral", 5)
    end)
    return ok and ch or nil
end
local CHANNEL = getGeneralChannel()

-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
local Settings = {
    ShowAllPlayersOnStart   = true,
    MessageStyle            = 1,         -- 1..10
    MessageDelay            = 2,         -- Ø«ÙˆØ§Ù†Ù Ø¨ÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    UseDeterministicRandom  = true,      -- RNG Ø­ØªÙ…ÙŠ Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
    MaxNameLength           = 20,        -- Ù„Ø¶Ø¨Ø· Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù…
    Traits = { "Ø°ÙƒØ§Ø¡","Ø¬Ù…Ø§Ù„","Ø·Ù…ÙˆØ­","Ø§Ù†Ø¶Ø¨Ø§Ø·","ØªØ±ÙƒÙŠØ²","Ø­ÙƒÙ…Ø©","Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©","Ù…Ø±ÙˆÙ†Ø©","Ø¥Ø¨Ø¯Ø§Ø¹","ØµØ¨Ø±" },
    PersonalityTypes = { "Ù‡Ø§Ø¯Ø¦","Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø¹ØµØ¨ÙŠ","ÙƒØªÙˆÙ…","ÙÙƒØ§Ù‡ÙŠ","Ø·Ù…ÙˆØ­","Ø¹Ù…Ù„ÙŠ","ÙØ¶ÙˆÙ„ÙŠ","Ù…ÙÙƒØ±","Ù…ØªÙØ§Ø¦Ù„" },
    SpecialCharacters = {
        "Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø¬ØªÙ‡Ø¯","Ø§Ù„ÙÙ†Ø§Ù† Ø§Ù„Ù…Ø¨Ø¯Ø¹","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹","Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ","Ø§Ù„Ù…ÙÙƒØ± Ø§Ù„Ù‡Ø§Ø¯Ø¦",
        "Ø§Ù„Ø´Ø®Øµ Ø§Ù„ÙÙƒØ§Ù‡ÙŠ","Ø§Ù„ÙƒØ§ØªØ¨ Ø§Ù„Ù…ÙˆÙ‡ÙˆØ¨","Ø§Ù„Ù…Ø®ØªØ±Ø¹","Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬","Ø§Ù„Ù…ØµÙˆØ± Ø§Ù„Ù…Ø§Ù‡Ø±",
        "Ø§Ù„Ù…ØºØ§Ù…Ø±","Ø§Ù„Ù…ØªØ¹Ù„Ù… Ø§Ù„Ù†Ù‡Ù…","Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ù†Ø¸Ù…","Ø±Ø§Ø¦Ø¯ Ø§Ù„Ø£Ø¹Ù…Ø§Ù„","Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ",
        "Ø§Ù„Ù†Ø§Ù‚Ø¯ Ø§Ù„ÙÙ†ÙŠ","Ø§Ù„Ù…Ø¹ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†","Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„ØªÙ‚Ù†ÙŠ","Ø§Ù„ÙŠÙˆØªÙŠÙˆØ¨Ø±","Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠ",
        "Ø§Ù„Ù…Ø¯Ø±Ø¨","Ø§Ù„Ù…Ø¯Ø±Ø³ Ø§Ù„ØµØ¨ÙˆØ±","Ø§Ù„Ù…Ø³ØªØ«Ù…Ø±","Ø§Ù„Ù…Ø³ØªØ´Ø§Ø±","Ø§Ù„Ù…ØªØ·ÙˆØ¹ Ø§Ù„Ù†Ø´Ø·",
        "Ø§Ù„Ø¨Ø§Ø­Ø«","Ø§Ù„Ø·Ø¨Ø§Ø® Ø§Ù„Ù…Ø¨Ø¯Ø¹","Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ø§Ù„Ø¹Ù…Ù„ÙŠ","Ø§Ù„Ù…Ù†Ø³Ù‚","Ø§Ù„Ù‡Ø§ÙˆÙŠ Ø§Ù„Ù…Ø¨Ø¯Ø¹",
        "Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù‡Ø§Ø¯Ø¦","Ø§Ù„Ø²Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¨ÙˆØ¨","Ø§Ù„Ù…ÙØ§ÙˆØ¶","Ø§Ù„Ù…Ù‡ØªÙ… Ø¨Ø§Ù„ØªÙØ§ØµÙŠÙ„","Ø§Ù„Ù†Ø§Ø´Ø· Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ",
        "Ø§Ù„Ù…Ø±Ø´Ø¯","Ø§Ù„Ù…ØªØ±Ø¬Ù…","Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ù†ÙØ³ÙŠ","ØµØ§Ù†Ø¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰","Ø§Ù„Ù…ØªØ¹Ø§Ø·Ù",
        "Ø§Ù„Ù‡Ø§ÙˆÙŠ Ø§Ù„ØªÙ‚Ù†ÙŠ","Ø§Ù„Ù…Ù†Ø¸Ù… Ø§Ù„Ø­Ø¯Ø«ÙŠ","Ø§Ù„Ø¨Ø³ØªØ§Ù†ÙŠ","Ø§Ù„Ø¨Ø§Ø­Ø« Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ","Ø§Ù„Ù…Ø³ØªÙƒØ´Ù Ø§Ù„Ø­Ø¶Ø±ÙŠ",
        "Ø§Ù„Ù…Ù†ÙØ°","Ø§Ù„Ù…Ø±Ù†","Ø§Ù„Ù…ØªØµØ±Ù","Ø§Ù„Ù…Ø¯Ø¨Ø±","Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø·Ù…ÙˆØ­"
    }
}

---------------------------------
-- Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ®Ø¯Ù…Ø§Øª Ù†ØµÙŠØ©  --
---------------------------------
-- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¨Ø£ÙˆÙ„ÙˆÙŠØ© TextChatServiceØ› Ø³Ù‚ÙˆØ· Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…ÙŠØ© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø´Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙØ©)
local function safeSend(message)
    local ch = CHANNEL or getGeneralChannel()
    if ch then
        local ok = pcall(function() ch:SendAsync(tostring(message)) end)
        if ok then return true end
    end
    -- Ø³Ù‚ÙˆØ· Ø¢Ù…Ù†: Ø±Ø³Ø§Ù„Ø© Ù†Ø¸Ø§Ù…ÙŠØ© Ù…Ø­Ù„ÙŠØ© ÙÙ‚Ø·
    pcall(function()
        StarterGui:SetCore("ChatMakeSystemMessage", {
            Text = tostring(message),
            Color = Color3.fromRGB(255, 215, 0),
            Font = Enum.Font.GothamBold,
            TextSize = 16
        })
    end)
    return false
end

-- Ù‚Øµ ÙˆØªÙ‡Ø°ÙŠØ¨ Ø§Ù„Ø§Ø³Ù… + Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·ÙˆÙ„
local function trimPlayerName(name)
    name = tostring(name or "")
    name = name:gsub("^%s+", ""):gsub("%s+$", "")
    local maxLen = Settings.MaxNameLength or 20
    if #name > maxLen then
        return name:sub(1, maxLen-3) .. "..."
    end
    return name
end

-- ØªÙ†Ø¸ÙŠÙ Ø¥Ø¯Ø®Ø§Ù„ (Ù‚Øµ Ù…Ø³Ø§ÙØ§Øª + Ù…Ù†Ø¹ Ø³Ù„Ø§Ø³Ù„ ÙØ§Ø±ØºØ©)
local function cleanInput(text)
    if type(text) ~= "string" then return nil end
    local t = text:match("^%s*(.-)%s*$")
    if t == "" then return nil end
    return t
end

-------------------------------
-- RNG Ø­ØªÙ…ÙŠ Ø®ÙÙŠÙ Ù„Ù„Ø¬Ù„Ø³Ø©     --
-------------------------------
local rngCache = {}  -- Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
local function rngForKey(key)
    if not Settings.UseDeterministicRandom then
        return Random.new()
    end
    key = tostring(key or "seed")
    if not rngCache[key] then
        -- Ø¨Ø°Ø±Ø© Ø´Ø¨Ù‡ Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ù…ÙØªØ§Ø­
        local h = 0
        for i = 1, #key do
            h = (h * 33 + key:byte(i)) % 2147483647
        end
        rngCache[key] = Random.new(h ~= 0 and h or os.time())
    end
    return rngCache[key]
end

local function randPercent(key)
    return rngForKey(key):NextInteger(0, 100)
end

local function pickRandomFromList(list, key)
    if type(list) ~= "table" or #list == 0 then return nil end
    local idx = rngForKey(key):NextInteger(1, #list)
    return list[idx]
end

-----------------------------
-- ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨   --
-----------------------------
local function buildPlayerInfo(plr)
    local info = {}
    local name = plr.DisplayName or plr.Name or "Ù„Ø§Ø¹Ø¨"
    info.rawName = name
    info.name    = trimPlayerName(name)
    info.userId  = plr.UserId or 0
    info.accountAge = plr.AccountAge or 0
    if info.accountAge > 0 then
        local joinTime = os.time() - (info.accountAge * 86400)
        info.joinDate = os.date("%Y-%m-%d", joinTime)
    else
        info.joinDate = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
    end

    -- Ø³Ù…Ø§Øª
    info.traits = {}
    for _, t in ipairs(Settings.Traits) do
        info.traits[t] = randPercent(info.userId .. t)
    end

    -- Ø§Ø®ØªÙŠØ§Ø±Ø§Øª
    info.personalityType = pickRandomFromList(Settings.PersonalityTypes, info.userId .. "P")
    info.specialCharacter = pickRandomFromList(Settings.SpecialCharacters, info.userId .. "S")
    info.specialTraitName = pickRandomFromList(Settings.Traits, info.userId .. "T")
    info.specialTraitValue = randPercent(info.userId .. "TV")

    return info
end

-- ÙƒØ§Ø´ Ù„Ù„Ø¬Ù„Ø³Ø© ÙÙ‚Ø·
local PlayerData = {}  -- [UserId] = info
local function ensurePlayerData(plr)
    local uid = plr.UserId
    if not PlayerData[uid] then
        PlayerData[uid] = buildPlayerInfo(plr)
    end
    return PlayerData[uid]
end

----------------------
-- Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø¹Ø±Ø¶ 1..10 --
----------------------
local DisplayStyles = {}

DisplayStyles[1] = function(info)
    local parts = {}
    for _, t in ipairs(Settings.Traits) do
        table.insert(parts, string.format("%s:%d%%", t, info.traits[t] or 0))
    end
    return {
        string.format("ğŸ‘¤ %s | %s | Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s",
            info.name, table.concat(parts, " | "), info.personalityType or "â€”", info.specialCharacter or "â€”")
    }
end

DisplayStyles[2] = function(info)
    local top = {}
    for _, t in ipairs(Settings.Traits) do
        table.insert(top, { t, info.traits[t] or 0 })
    end
    table.sort(top, function(a,b) return a[2] > b[2] end)
    local buf = {}
    for i = 1, math.min(3, #top) do
        table.insert(buf, string.format("%s:%d%%", top[i][1], top[i][2]))
    end
    return { string.format("â­ %s | Ø£Ø¹Ù„Ù‰: %s | Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s",
        info.name, table.concat(buf, " / "), info.personalityType or "â€”", info.specialCharacter or "â€”") }
end

DisplayStyles[3] = function(info)
    local buf = {}
    for _, t in ipairs(Settings.Traits) do
        local v = info.traits[t] or 0
        local bars = string.rep("â–ˆ", math.floor(v/10))
        table.insert(buf, string.format("%s[%s]%d%%", t, bars, v))
    end
    return { "ğŸ“Š "..info.name, table.concat(buf, " | "),
             string.format("Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s", info.personalityType or "â€”", info.specialCharacter or "â€”") }
end

DisplayStyles[4] = function(info)
    return {
        string.format("ğŸ†” %s | Ø¹Ù…Ø±:%d ÙŠÙˆÙ… | Ø§Ù†Ø¶Ù…:%s",
            info.name, info.accountAge or 0, info.joinDate or "â€”"),
        string.format("Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s", info.personalityType or "â€”", info.specialCharacter or "â€”")
    }
end

DisplayStyles[5] = function(info)
    local mapping = {
        ["Ø°ÙƒØ§Ø¡"]="ğŸ§ ",["Ø¬Ù…Ø§Ù„"]="ğŸ’«",["Ø·Ù…ÙˆØ­"]="ğŸš€",["Ø§Ù†Ø¶Ø¨Ø§Ø·"]="ğŸ”§",
        ["ØªØ±ÙƒÙŠØ²"]="ğŸ¯",["Ø­ÙƒÙ…Ø©"]="ğŸ“š",["Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©"]="ğŸ¤",["Ù…Ø±ÙˆÙ†Ø©"]="ğŸŒ€",
        ["Ø¥Ø¨Ø¯Ø§Ø¹"]="âœ¨",["ØµØ¨Ø±"]="â³"
    }
    local parts={}
    for _,t in ipairs(Settings.Traits) do
        local v=info.traits[t] or 0
        table.insert(parts,string.format("%s %d%%", mapping[t] or "â€¢", v))
    end
    return { string.format("ğŸ¨ %s | %s | Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s",
        info.name, table.concat(parts, " "), info.personalityType or "â€”", info.specialCharacter or "â€”") }
end

-- Ù…Ø¬Ù…ÙˆØ¹Ø© Ø³Ø±ÙŠØ¹Ø© (ÙŠØ¹Ø±Ø¶ 3 Ù…Ø¹Ø§Ù‹)
DisplayStyles[6] = function(infoList)
    local parts = {}
    for _, info in ipairs(infoList) do
        local firstTrait = Settings.Traits[1]
        local v = info.traits[firstTrait] or 0
        table.insert(parts, string.format("%s(%s:%d%%)", info.name, firstTrait, v))
    end
    return { "âš¡ Ù…Ø¬Ù…ÙˆØ¹Ø©: " .. table.concat(parts, " | ") }
end

DisplayStyles[7] = function(info)
    return { string.format("ğŸ·ï¸ %s â€” %s", info.name, info.specialCharacter or "â€”") }
end

DisplayStyles[8] = function(info)
    local keys = {}
    for _, t in ipairs(Settings.Traits) do table.insert(keys, t) end
    -- ØªØ±ØªÙŠØ¨ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø­ØªÙ…ÙŠ
    local rng = rngForKey(info.userId .. "order")
    for i = #keys, 2, -1 do
        local j = rng:NextInteger(1, i)
        keys[i], keys[j] = keys[j], keys[i]
    end
    local parts = {}
    for _, t in ipairs(keys) do
        table.insert(parts, string.format("%s:%d%%", t, info.traits[t] or 0))
    end
    return { string.format("ğŸ”€ %s | %s | Ù†ÙˆØ¹:%s",
        info.name, table.concat(parts, " | "), info.personalityType or "â€”") }
end

DisplayStyles[9] = function(info)
    local function level(v)
        if v >= 70 then return "Ù…Ø±ØªÙØ¹" elseif v >= 40 then return "Ù…ØªÙˆØ³Ø·" else return "Ù…Ù†Ø®ÙØ¶" end
    end
    local parts={}
    for _, t in ipairs(Settings.Traits) do
        table.insert(parts, string.format("%s:%s", t, level(info.traits[t] or 0)))
    end
    return { string.format("ğŸ“ %s | %s | Ø®Ø§Øµ:%s",
        info.name, table.concat(parts, " | "), info.specialCharacter or "â€”") }
end

DisplayStyles[10] = function(info)
    return {
        string.format("ğŸ‘¤ %s (ID:%d) | Ù†ÙˆØ¹:%s | Ø®Ø§Øµ:%s (%s:%d%%)",
            info.name, info.userId or 0, info.personalityType or "â€”",
            info.specialCharacter or "â€”", info.specialTraitName or "â€”", info.specialTraitValue or 0)
    }
end

----------------------------------
-- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ£Ù†Ù…Ø§Ø· Ø§Ù„Ø¯ÙÙ‚Ø§Øª --
----------------------------------
local busy = false

local function renderPlayerInfo(plr, styleIndex)
    local info = ensurePlayerData(plr)
    local sty = DisplayStyles[styleIndex or Settings.MessageStyle] or DisplayStyles[1]

    -- Ù†Ù…Ø· 6 Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©Ø› Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙØ±Ø¯ÙŠØ©
    if sty == DisplayStyles[6] then
        local list = {}
        table.insert(list, info)
        local msgs = DisplayStyles[6](list)
        for i, line in ipairs(msgs or {}) do
            safeSend(line)
            if i < #msgs and Settings.MessageDelay > 0 then
                task.wait(Settings.MessageDelay*0.25)
            end
        end
        return
    end

    local lines = sty(info) or {}
    for i, line in ipairs(lines) do
        safeSend(line)
        if i < #lines and Settings.MessageDelay > 0 then
            task.wait(Settings.MessageDelay*0.25)
        end
    end
end

local function showAllPlayersInfo(styleIndex)
    if busy then return end
    busy = true

    local list = Players:GetPlayers()
    table.sort(list, function(a,b)
        local ad = tostring(a.DisplayName or a.Name)
        local bd = tostring(b.DisplayName or b.Name)
        return ad:lower() < bd:lower()
    end)

    -- Ù„Ø§ Ù†ÙƒØ±Ø± Ù†ÙØ³Ùƒ Ø£ÙˆÙ„Ø§Ù‹
    safeSend(("ğŸ“Š Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (%d):"):format(#list))
    task.wait(math.max(0.25, (Settings.MessageDelay or 0)))

    if (DisplayStyles[styleIndex or Settings.MessageStyle] == DisplayStyles[6]) then
        -- Ø¯ÙØ¹Ø§Øª Ù…Ù† 3 Ù„Ø§Ø¹Ø¨ÙŠÙ†
        local batch, count = {}, 0
        for _, plr in ipairs(list) do
            if plr ~= localPlayer then
                table.insert(batch, ensurePlayerData(plr))
                count += 1
                if #batch >= 3 then
                    for _, line in ipairs(DisplayStyles[6](batch) or {}) do
                        safeSend(line)
                        task.wait(Settings.MessageDelay or 0)
                    end
                    batch = {}
                end
            end
        end
        if #batch > 0 then
            for _, line in ipairs(DisplayStyles[6](batch) or {}) do
                safeSend(line); task.wait(Settings.MessageDelay or 0)
            end
        end
        if count == 0 then safeSend("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.") end
    else
        local shown = 0
        for _, plr in ipairs(list) do
            if plr ~= localPlayer then
                renderPlayerInfo(plr, styleIndex)
                shown += 1
                task.wait(Settings.MessageDelay or 0)
            end
        end
        if shown == 0 then safeSend("â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø¢Ø®Ø±ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.") end
    end

    busy = false
end

--------------------------
-- Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª Ø§Ù„Ø­Ø¯ÙŠØ«Ø© --
--------------------------
local function processChatCommand(textSource, rawText)
    if not textSource then return end
    if textSource.UserId ~= localPlayer.UserId then return end
    local message = tostring(rawText or "")
    local args = {}
    for w in message:gmatch("%S+") do table.insert(args, w) end
    if #args == 0 then return end

    if args[1] == "!Ø§Ù„ÙƒÙ„" then
        showAllPlayersInfo(Settings.MessageStyle)

    elseif args[1] == "!Ù†Ù…Ø·" and args[2] then
        local n = tonumber(args[2])
        if n then
            Settings.MessageStyle = math.clamp(n, 1, 10)
            safeSend(("âœ… ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù†Ù…Ø· Ø¥Ù„Ù‰ %d"):format(Settings.MessageStyle))
        end

    elseif args[1] == "!Ø¹Ø±Ø¶" and args[2] then
        local target = args[2]:lower()
        local found = nil
        for _, p in ipairs(Players:GetPlayers()) do
            local dn = tostring(p.DisplayName or ""):lower()
            local nn = tostring(p.Name or ""):lower()
            if dn:sub(1, #target) == target or nn:sub(1, #target) == target then
                found = p; break
            end
        end
        if found then
            renderPlayerInfo(found, Settings.MessageStyle)
        else
            safeSend("âŒ Ù„Ø§Ø¹Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù….")
        end

    elseif args[1] == "!Ù‚Ø§Ø¦Ù…Ø©" then
        safeSend("ğŸ“ Ø§Ù„Ø£ÙˆØ§Ù…Ø±: !Ø§Ù„ÙƒÙ„ | !Ù†Ù…Ø· [1..10] | !Ø¹Ø±Ø¶ [Ø§Ø³Ù…] | !ÙˆØ§Ø¬Ù‡Ø©")

    elseif args[1] == "!ÙˆØ§Ø¬Ù‡Ø©" then
        local ui = _G.__PlayerInfoUI and _G.__PlayerInfoUI()
        if ui then ui.Enabled = true end
    end
end

-- Ø±Ø¨Ø· Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø´Ø§Øª
do
    local ch = CHANNEL or getGeneralChannel()
    if ch and ch.OnIncomingMessage then
        ch.OnIncomingMessage:Connect(function(msg)
            task.spawn(function()
                local ok, err = pcall(function()
                    processChatCommand(msg.TextSource, msg.Text)
                end)
                if not ok then warn(err) end
            end)
        end)
    else
        -- Ø³Ù‚ÙˆØ· Ø¢Ù…Ù†: Ù„Ùˆ Ù…Ø§ ÙÙŠ Ù‚Ù†Ø§Ø© Ø¹Ø§Ù…Ø© Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ù…Ø§ Ù†ÙƒØ³Ø± Ø§Ù„Ù„Ø¹Ø¨Ø› Ù†Ø³ØªÙ…Ø± Ø¨Ø¯ÙˆÙ† Ø£ÙˆØ§Ù…Ø± Ø´Ø§Øª
        warn("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ RBXGeneral. Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø´Ø§Øª Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„.")
    end
end

-------------------------
-- ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ø§Ø¨ØªØ©  --
-------------------------
local function createOrGetUI()
    if _G.__PlayerInfoUI then return _G.__PlayerInfoUI() end

    local pg = localPlayer:WaitForChild("PlayerGui")
    local existing = pg:FindFirstChild("PlayerInfoSettingsPro")
    if existing then
        _G.__PlayerInfoUI = function() return existing end
        return existing
    end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PlayerInfoSettingsPro"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = false
    screenGui.Parent = pg

    -- Ù…Ù‚ÙŠØ§Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø¬ÙˆØ§Ù„
    local uiScale = Instance.new("UIScale")
    uiScale.Parent = screenGui
    local function updateScale()
        local s = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
        local minDim = math.min(s.X, s.Y)
        uiScale.Scale = math.clamp(minDim/900, 0.8, 1.1)
    end
    updateScale()
    if workspace.CurrentCamera then
        workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(updateScale)
    end

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "Main"
    mainFrame.Size = UDim2.new(0, 540, 0, 440)
    mainFrame.Position = UDim2.new(0.5, -270, 0.5, -220)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 42)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    title.BorderSizePixel = 0
    title.Text = "âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Pro)"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.Parent = mainFrame

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 40, 0, 42)
    closeBtn.Position = UDim2.new(1, -40, 0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "âŒ"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 18
    closeBtn.Parent = title
    closeBtn.MouseButton1Click:Connect(function()
        screenGui.Enabled = not screenGui.Enabled
    end)

    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = UDim2.new(1, -20, 1, -105)
    scroll.Position = UDim2.new(0, 10, 0, 50)
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 8
    scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    scroll.Parent = mainFrame

    -- Ù…ÙØµÙ†Ù‘Ø¹ Ø£Ù‚Ø³Ø§Ù…
    local function section(titleText, y)
        local sec = Instance.new("Frame")
        sec.Size = UDim2.new(1, 0, 0, 150)
        sec.Position = UDim2.new(0, 0, 0, y)
        sec.BackgroundTransparency = 1
        sec.Parent = scroll

        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, 0, 0, 20)
        lbl.BackgroundTransparency = 1
        lbl.Text = titleText
        lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Parent = sec

        local listFrame = Instance.new("ScrollingFrame")
        listFrame.Name = "List"
        listFrame.Size = UDim2.new(1, -40, 1, -60)
        listFrame.Position = UDim2.new(0, 0, 0, 25)
        listFrame.BackgroundTransparency = 0.1
        listFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        listFrame.BorderSizePixel = 0
        listFrame.ScrollBarThickness = 6
        listFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
        listFrame.Parent = sec

        local input = Instance.new("TextBox")
        input.Name = "Input"
        input.Size = UDim2.new(1, -40, 0, 30)
        input.Position = UDim2.new(0, 0, 1, -30)
        input.PlaceholderText = "Ø£Ø¶Ù/Ø¹Ø¯Ù‘Ù„..."
        input.ClearTextOnFocus = false
        input.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        input.BorderSizePixel = 0
        input.TextColor3 = Color3.fromRGB(255, 255, 255)
        input.Font = Enum.Font.Gotham
        input.TextSize = 14
        input.Parent = sec

        local addBtn = Instance.new("TextButton")
        addBtn.Name = "Add"
        addBtn.Size = UDim2.new(0, 30, 0, 30)
        addBtn.Position = UDim2.new(1, -30, 1, -30)
        addBtn.BackgroundColor3 = Color3.fromRGB(60, 160, 60)
        addBtn.BorderSizePixel = 0
        addBtn.Text = "â•"
        addBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        addBtn.Font = Enum.Font.GothamBold
        addBtn.TextSize = 16
        addBtn.Parent = sec

        return sec, listFrame, input, addBtn
    end

    local traitsSec, traitsList, traitInput, addTraitBtn = section("Ø§Ù„ØµÙØ§Øª (Traits):", 0)
    local typesSec,  typesList,  typeInput,  addTypeBtn  = section("Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª (Personality):", 160)
    local specialSec,specialList,specialInput,addSpecialBtn= section("Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ø®Ø§ØµØ© (Special):", 320)

    scroll.CanvasSize = UDim2.new(0,0,0,480)

    local bottom = Instance.new("Frame")
    bottom.Size = UDim2.new(1, 0, 0, 42)
    bottom.Position = UDim2.new(0, 0, 1, -42)
    bottom.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    bottom.BorderSizePixel = 0
    bottom.Parent = mainFrame

    local showAllBtn = Instance.new("TextButton")
    showAllBtn.Size = UDim2.new(0, 160, 0, 30)
    showAllBtn.Position = UDim2.new(0, 10, 0.5, -15)
    showAllBtn.BackgroundColor3 = Color3.fromRGB(50, 120, 200)
    showAllBtn.BorderSizePixel = 0
    showAllBtn.Text = "ğŸ“Š Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†"
    showAllBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    showAllBtn.Font = Enum.Font.Gotham
    showAllBtn.TextSize = 14
    showAllBtn.Parent = bottom

    local randomizeBtn = Instance.new("TextButton")
    randomizeBtn.Size = UDim2.new(0, 180, 0, 30)
    randomizeBtn.Position = UDim2.new(0, 180, 0.5, -15)
    randomizeBtn.BackgroundColor3 = Color3.fromRGB(60, 160, 60)
    randomizeBtn.BorderSizePixel = 0
    randomizeBtn.Text = "ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§ØªÙŠ"
    randomizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    randomizeBtn.Font = Enum.Font.Gotham
    randomizeBtn.TextSize = 14
    randomizeBtn.Parent = bottom

    local styleLabel = Instance.new("TextLabel")
    styleLabel.Size = UDim2.new(0, 100, 0, 30)
    styleLabel.Position = UDim2.new(1, -210, 0.5, -15)
    styleLabel.BackgroundTransparency = 1
    styleLabel.Text = "Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶:"
    styleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    styleLabel.Font = Enum.Font.Gotham
    styleLabel.TextSize = 14
    styleLabel.Parent = bottom

    local styleBox = Instance.new("TextBox")
    styleBox.Size = UDim2.new(0, 80, 0, 30)
    styleBox.Position = UDim2.new(1, -120, 0.5, -15)
    styleBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    styleBox.BorderSizePixel = 0
    styleBox.Text = tostring(Settings.MessageStyle)
    styleBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    styleBox.Font = Enum.Font.Gotham
    styleBox.TextSize = 14
    styleBox.Parent = bottom

    -- Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± + ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
    local function populateList(listFrame, items, onRemove)
        listFrame:ClearAllChildren()
        local y = 0
        for _, item in ipairs(items) do
            local row = Instance.new("TextButton")
            row.Size = UDim2.new(1, -10, 0, 28)
            row.Position = UDim2.new(0, 5, 0, y)
            row.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            row.BorderSizePixel = 0
            row.TextXAlignment = Enum.TextXAlignment.Left
            row.Text = "  " .. tostring(item)
            row.TextColor3 = Color3.fromRGB(255, 255, 255)
            row.Font = Enum.Font.Gotham
            row.TextSize = 14
            row.Parent = listFrame

            -- Ø­Ø°Ù Ø¨Ø§Ù„Ø²Ø± Ø§Ù„Ø£ÙŠÙ…Ù†
            row.MouseButton2Click:Connect(function()
                for i = #items, 1, -1 do
                    if items[i] == item then
                        table.remove(items, i)
                        break
                    end
                end
                populateList(listFrame, items, onRemove)
                if onRemove then onRemove(item) end
            end)

            y = y + 30
        end
        listFrame.CanvasSize = UDim2.new(0, 0, 0, y)
    end

    local function addUnique(items, value, okMsg, existsMsg)
        value = cleanInput(value)
        if not value then return end
        for _, v in ipairs(items) do
            if v == value then
                safeSend(existsMsg or ("âš ï¸ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹: " .. value))
                return
            end
        end
        table.insert(items, value)
        safeSend(okMsg or ("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ©: " .. value))
    end

    local function refreshAll()
        populateList(traitsList, Settings.Traits, function(item) safeSend("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„ØµÙØ©: " .. item) end)
        populateList(typesList, Settings.PersonalityTypes, function(item) safeSend("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ¹: " .. item) end)
        populateList(specialList, Settings.SpecialCharacters, function(item) safeSend("ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø®Ø§ØµØ©: " .. item) end)
    end

    addTraitBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.Traits, traitInput.Text, "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØµÙØ©.", "âš ï¸ Ø§Ù„ØµÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø©.")
        traitInput.Text = ""; refreshAll()
    end)
    addTypeBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.PersonalityTypes, typeInput.Text, "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹.", "âš ï¸ Ø§Ù„Ù†ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯.")
        typeInput.Text = ""; refreshAll()
    end)
    addSpecialBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.SpecialCharacters, specialInput.Text, "âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø´Ø®ØµÙŠØ©.", "âš ï¸ Ø§Ù„Ø´Ø®ØµÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©.")
        specialInput.Text = ""; refreshAll()
    end)

    showAllBtn.MouseButton1Click:Connect(function()
        local v = tonumber(styleBox.Text)
        if v then Settings.MessageStyle = math.clamp(v,1,10) end
        showAllPlayersInfo(Settings.MessageStyle)
    end)
    randomizeBtn.MouseButton1Click:Connect(function()
        -- Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆÙ„ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙÙ‚Ø· (Ø­ØªÙ…ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯)
        PlayerData[localPlayer.UserId] = buildPlayerInfo(localPlayer)
        local v = tonumber(styleBox.Text)
        if v then Settings.MessageStyle = math.clamp(v,1,10) end
        renderPlayerInfo(localPlayer, Settings.MessageStyle)
    end)

    refreshAll()

    _G.__PlayerInfoUI = function() return screenGui end
    return screenGui
end

-- Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
local UI = createOrGetUI()
UI.Enabled = true

--------------------------
-- Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†  --
--------------------------
Players.PlayerAdded:Connect(function(plr)
    ensurePlayerData(plr)
    task.wait(1)
    if Settings.ShowAllPlayersOnStart then
        renderPlayerInfo(plr, Settings.MessageStyle)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    PlayerData[plr.UserId] = nil
end)

-----------------
-- ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ  --
-----------------
ensurePlayerData(localPlayer)
safeSend("âœ… Ù†Ø¸Ø§Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Pro) Ø¬Ø§Ù‡Ø²!")
safeSend("ğŸ“ Ø£ÙˆØ§Ù…Ø±: !Ø§Ù„ÙƒÙ„ | !Ù†Ù…Ø· [1..10] | !Ø¹Ø±Ø¶ [Ø§Ø³Ù…] | !ÙˆØ§Ø¬Ù‡Ø©")

if Settings.ShowAllPlayersOnStart then
    task.wait(2)
    showAllPlayersInfo(Settings.MessageStyle)
end
