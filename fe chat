--[[
    نظام معلومات اللاعبين - نسخة مستقرة وخفيفة "Pro"
    - أسلوب حديث: TextChatService (RBXGeneral:SendAsync)
    - واجهة واحدة ثابتة (تظهر/تُخفى بدون حذف/إعادة إنشاء)
    - دمج أفكار السكربت القديم (أنماط عرض كثيرة + توسعة عبر GUI)
    - خفة وتنظيم السكربت الجديد (دوال واضحة + RNG حتمي اختياري)
    - تنظيف إدخال المستخدم + منع التكرارات + ترتيب النتائج
    - لا يعتمد على أي موارد من الماب
]]--

----------------------------
-- الإعداد والتهيئة العامة --
----------------------------
if not game:IsLoaded() then
    game.Loaded:Wait()
end

local Players            = game:GetService("Players")
local TextChatService    = game:GetService("TextChatService")
local StarterGui         = game:GetService("StarterGui")

local localPlayer = Players.LocalPlayer or Players.PlayerAdded:Wait()

-- القناة العامة الحديثة
local function getGeneralChannel()
    local ok, ch = pcall(function()
        local channels = TextChatService:WaitForChild("TextChannels")
        return channels:WaitForChild("RBXGeneral", 5)
    end)
    return ok and ch or nil
end
local CHANNEL = getGeneralChannel()

-- إعدادات
local Settings = {
    ShowAllPlayersOnStart   = true,
    MessageStyle            = 1,         -- 1..10
    MessageDelay            = 2,         -- ثوانٍ بين الرسائل
    UseDeterministicRandom  = true,      -- RNG حتمي لكل لاعب
    MaxNameLength           = 20,        -- لضبط عرض الاسم
    Traits = { "ذكاء","جمال","طموح","انضباط","تركيز","حكمة","اجتماعية","مرونة","إبداع","صبر" },
    PersonalityTypes = { "هادئ","اجتماعي","عصبي","كتوم","فكاهي","طموح","عملي","فضولي","مفكر","متفائل" },
    SpecialCharacters = {
        "الطالب المجتهد","الفنان المبدع","الرياضي السريع","القائد الاجتماعي","المفكر الهادئ",
        "الشخص الفكاهي","الكاتب الموهوب","المخترع","المبرمج","المصور الماهر",
        "المغامر","المتعلم النهم","الموظف المنظم","رائد الأعمال","المنظم الاجتماعي",
        "الناقد الفني","المعيد المتعاون","الخبير التقني","اليوتيوبر","المحلل الرياضي",
        "المدرب","المدرس الصبور","المستثمر","المستشار","المتطوع النشط",
        "الباحث","الطباخ المبدع","المهندس العملي","المنسق","الهاوي المبدع",
        "الموظف الهادئ","الزميل المحبوب","المفاوض","المهتم بالتفاصيل","الناشط الاجتماعي",
        "المرشد","المترجم","المحلل النفسي","صانع المحتوى","المتعاطف",
        "الهاوي التقني","المنظم الحدثي","البستاني","الباحث التاريخي","المستكشف الحضري",
        "المنفذ","المرن","المتصرف","المدبر","الشخص الطموح"
    }
}

---------------------------------
-- أدوات مساعدة وخدمات نصية  --
---------------------------------
-- إرسال رسالة بأولوية TextChatService؛ سقوط آمن إلى رسالة نظامية فقط (بدون الشات القديم للحفاظ على الخفة)
local function safeSend(message)
    local ch = CHANNEL or getGeneralChannel()
    if ch then
        local ok = pcall(function() ch:SendAsync(tostring(message)) end)
        if ok then return true end
    end
    -- سقوط آمن: رسالة نظامية محلية فقط
    pcall(function()
        StarterGui:SetCore("ChatMakeSystemMessage", {
            Text = tostring(message),
            Color = Color3.fromRGB(255, 215, 0),
            Font = Enum.Font.GothamBold,
            TextSize = 16
        })
    end)
    return false
end

-- قص وتهذيب الاسم + حد أقصى للطول
local function trimPlayerName(name)
    name = tostring(name or "")
    name = name:gsub("^%s+", ""):gsub("%s+$", "")
    local maxLen = Settings.MaxNameLength or 20
    if #name > maxLen then
        return name:sub(1, maxLen-3) .. "..."
    end
    return name
end

-- تنظيف إدخال (قص مسافات + منع سلاسل فارغة)
local function cleanInput(text)
    if type(text) ~= "string" then return nil end
    local t = text:match("^%s*(.-)%s*$")
    if t == "" then return nil end
    return t
end

-------------------------------
-- RNG حتمي خفيف للجلسة     --
-------------------------------
local rngCache = {}  -- لكل لاعب
local function rngForKey(key)
    if not Settings.UseDeterministicRandom then
        return Random.new()
    end
    key = tostring(key or "seed")
    if not rngCache[key] then
        -- بذرة شبه ثابتة لكل مفتاح
        local h = 0
        for i = 1, #key do
            h = (h * 33 + key:byte(i)) % 2147483647
        end
        rngCache[key] = Random.new(h ~= 0 and h or os.time())
    end
    return rngCache[key]
end

local function randPercent(key)
    return rngForKey(key):NextInteger(0, 100)
end

local function pickRandomFromList(list, key)
    if type(list) ~= "table" or #list == 0 then return nil end
    local idx = rngForKey(key):NextInteger(1, #list)
    return list[idx]
end

-----------------------------
-- توليد معلومات اللاعب   --
-----------------------------
local function buildPlayerInfo(plr)
    local info = {}
    local name = plr.DisplayName or plr.Name or "لاعب"
    info.rawName = name
    info.name    = trimPlayerName(name)
    info.userId  = plr.UserId or 0
    info.accountAge = plr.AccountAge or 0
    if info.accountAge > 0 then
        local joinTime = os.time() - (info.accountAge * 86400)
        info.joinDate = os.date("%Y-%m-%d", joinTime)
    else
        info.joinDate = "غير معروف"
    end

    -- سمات
    info.traits = {}
    for _, t in ipairs(Settings.Traits) do
        info.traits[t] = randPercent(info.userId .. t)
    end

    -- اختيارات
    info.personalityType = pickRandomFromList(Settings.PersonalityTypes, info.userId .. "P")
    info.specialCharacter = pickRandomFromList(Settings.SpecialCharacters, info.userId .. "S")
    info.specialTraitName = pickRandomFromList(Settings.Traits, info.userId .. "T")
    info.specialTraitValue = randPercent(info.userId .. "TV")

    return info
end

-- كاش للجلسة فقط
local PlayerData = {}  -- [UserId] = info
local function ensurePlayerData(plr)
    local uid = plr.UserId
    if not PlayerData[uid] then
        PlayerData[uid] = buildPlayerInfo(plr)
    end
    return PlayerData[uid]
end

----------------------
-- أنماط العرض 1..10 --
----------------------
local DisplayStyles = {}

DisplayStyles[1] = function(info)
    local parts = {}
    for _, t in ipairs(Settings.Traits) do
        table.insert(parts, string.format("%s:%d%%", t, info.traits[t] or 0))
    end
    return {
        string.format("👤 %s | %s | نوع:%s | خاص:%s",
            info.name, table.concat(parts, " | "), info.personalityType or "—", info.specialCharacter or "—")
    }
end

DisplayStyles[2] = function(info)
    local top = {}
    for _, t in ipairs(Settings.Traits) do
        table.insert(top, { t, info.traits[t] or 0 })
    end
    table.sort(top, function(a,b) return a[2] > b[2] end)
    local buf = {}
    for i = 1, math.min(3, #top) do
        table.insert(buf, string.format("%s:%d%%", top[i][1], top[i][2]))
    end
    return { string.format("⭐ %s | أعلى: %s | نوع:%s | خاص:%s",
        info.name, table.concat(buf, " / "), info.personalityType or "—", info.specialCharacter or "—") }
end

DisplayStyles[3] = function(info)
    local buf = {}
    for _, t in ipairs(Settings.Traits) do
        local v = info.traits[t] or 0
        local bars = string.rep("█", math.floor(v/10))
        table.insert(buf, string.format("%s[%s]%d%%", t, bars, v))
    end
    return { "📊 "..info.name, table.concat(buf, " | "),
             string.format("نوع:%s | خاص:%s", info.personalityType or "—", info.specialCharacter or "—") }
end

DisplayStyles[4] = function(info)
    return {
        string.format("🆔 %s | عمر:%d يوم | انضم:%s",
            info.name, info.accountAge or 0, info.joinDate or "—"),
        string.format("نوع:%s | خاص:%s", info.personalityType or "—", info.specialCharacter or "—")
    }
end

DisplayStyles[5] = function(info)
    local mapping = {
        ["ذكاء"]="🧠",["جمال"]="💫",["طموح"]="🚀",["انضباط"]="🔧",
        ["تركيز"]="🎯",["حكمة"]="📚",["اجتماعية"]="🤝",["مرونة"]="🌀",
        ["إبداع"]="✨",["صبر"]="⏳"
    }
    local parts={}
    for _,t in ipairs(Settings.Traits) do
        local v=info.traits[t] or 0
        table.insert(parts,string.format("%s %d%%", mapping[t] or "•", v))
    end
    return { string.format("🎨 %s | %s | نوع:%s | خاص:%s",
        info.name, table.concat(parts, " "), info.personalityType or "—", info.specialCharacter or "—") }
end

-- مجموعة سريعة (يعرض 3 معاً)
DisplayStyles[6] = function(infoList)
    local parts = {}
    for _, info in ipairs(infoList) do
        local firstTrait = Settings.Traits[1]
        local v = info.traits[firstTrait] or 0
        table.insert(parts, string.format("%s(%s:%d%%)", info.name, firstTrait, v))
    end
    return { "⚡ مجموعة: " .. table.concat(parts, " | ") }
end

DisplayStyles[7] = function(info)
    return { string.format("🏷️ %s — %s", info.name, info.specialCharacter or "—") }
end

DisplayStyles[8] = function(info)
    local keys = {}
    for _, t in ipairs(Settings.Traits) do table.insert(keys, t) end
    -- ترتيب عشوائي حتمي
    local rng = rngForKey(info.userId .. "order")
    for i = #keys, 2, -1 do
        local j = rng:NextInteger(1, i)
        keys[i], keys[j] = keys[j], keys[i]
    end
    local parts = {}
    for _, t in ipairs(keys) do
        table.insert(parts, string.format("%s:%d%%", t, info.traits[t] or 0))
    end
    return { string.format("🔀 %s | %s | نوع:%s",
        info.name, table.concat(parts, " | "), info.personalityType or "—") }
end

DisplayStyles[9] = function(info)
    local function level(v)
        if v >= 70 then return "مرتفع" elseif v >= 40 then return "متوسط" else return "منخفض" end
    end
    local parts={}
    for _, t in ipairs(Settings.Traits) do
        table.insert(parts, string.format("%s:%s", t, level(info.traits[t] or 0)))
    end
    return { string.format("📐 %s | %s | خاص:%s",
        info.name, table.concat(parts, " | "), info.specialCharacter or "—") }
end

DisplayStyles[10] = function(info)
    return {
        string.format("👤 %s (ID:%d) | نوع:%s | خاص:%s (%s:%d%%)",
            info.name, info.userId or 0, info.personalityType or "—",
            info.specialCharacter or "—", info.specialTraitName or "—", info.specialTraitValue or 0)
    }
end

----------------------------------
-- إرسال الرسائل وأنماط الدفقات --
----------------------------------
local busy = false

local function renderPlayerInfo(plr, styleIndex)
    local info = ensurePlayerData(plr)
    local sty = DisplayStyles[styleIndex or Settings.MessageStyle] or DisplayStyles[1]

    -- نمط 6 خاص بالمجموعة؛ بقية الأنماط فردية
    if sty == DisplayStyles[6] then
        local list = {}
        table.insert(list, info)
        local msgs = DisplayStyles[6](list)
        for i, line in ipairs(msgs or {}) do
            safeSend(line)
            if i < #msgs and Settings.MessageDelay > 0 then
                task.wait(Settings.MessageDelay*0.25)
            end
        end
        return
    end

    local lines = sty(info) or {}
    for i, line in ipairs(lines) do
        safeSend(line)
        if i < #lines and Settings.MessageDelay > 0 then
            task.wait(Settings.MessageDelay*0.25)
        end
    end
end

local function showAllPlayersInfo(styleIndex)
    if busy then return end
    busy = true

    local list = Players:GetPlayers()
    table.sort(list, function(a,b)
        local ad = tostring(a.DisplayName or a.Name)
        local bd = tostring(b.DisplayName or b.Name)
        return ad:lower() < bd:lower()
    end)

    -- لا نكرر نفسك أولاً
    safeSend(("📊 عرض معلومات اللاعبين (%d):"):format(#list))
    task.wait(math.max(0.25, (Settings.MessageDelay or 0)))

    if (DisplayStyles[styleIndex or Settings.MessageStyle] == DisplayStyles[6]) then
        -- دفعات من 3 لاعبين
        local batch, count = {}, 0
        for _, plr in ipairs(list) do
            if plr ~= localPlayer then
                table.insert(batch, ensurePlayerData(plr))
                count += 1
                if #batch >= 3 then
                    for _, line in ipairs(DisplayStyles[6](batch) or {}) do
                        safeSend(line)
                        task.wait(Settings.MessageDelay or 0)
                    end
                    batch = {}
                end
            end
        end
        if #batch > 0 then
            for _, line in ipairs(DisplayStyles[6](batch) or {}) do
                safeSend(line); task.wait(Settings.MessageDelay or 0)
            end
        end
        if count == 0 then safeSend("ℹ️ لا يوجد لاعبون آخرون حالياً.") end
    else
        local shown = 0
        for _, plr in ipairs(list) do
            if plr ~= localPlayer then
                renderPlayerInfo(plr, styleIndex)
                shown += 1
                task.wait(Settings.MessageDelay or 0)
            end
        end
        if shown == 0 then safeSend("ℹ️ لا يوجد لاعبون آخرون حالياً.") end
    end

    busy = false
end

--------------------------
-- أوامر الشات الحديثة --
--------------------------
local function processChatCommand(textSource, rawText)
    if not textSource then return end
    if textSource.UserId ~= localPlayer.UserId then return end
    local message = tostring(rawText or "")
    local args = {}
    for w in message:gmatch("%S+") do table.insert(args, w) end
    if #args == 0 then return end

    if args[1] == "!الكل" then
        showAllPlayersInfo(Settings.MessageStyle)

    elseif args[1] == "!نمط" and args[2] then
        local n = tonumber(args[2])
        if n then
            Settings.MessageStyle = math.clamp(n, 1, 10)
            safeSend(("✅ تم تغيير النمط إلى %d"):format(Settings.MessageStyle))
        end

    elseif args[1] == "!عرض" and args[2] then
        local target = args[2]:lower()
        local found = nil
        for _, p in ipairs(Players:GetPlayers()) do
            local dn = tostring(p.DisplayName or ""):lower()
            local nn = tostring(p.Name or ""):lower()
            if dn:sub(1, #target) == target or nn:sub(1, #target) == target then
                found = p; break
            end
        end
        if found then
            renderPlayerInfo(found, Settings.MessageStyle)
        else
            safeSend("❌ لاعب غير موجود بهذا الاسم.")
        end

    elseif args[1] == "!قائمة" then
        safeSend("📝 الأوامر: !الكل | !نمط [1..10] | !عرض [اسم] | !واجهة")

    elseif args[1] == "!واجهة" then
        local ui = _G.__PlayerInfoUI and _G.__PlayerInfoUI()
        if ui then ui.Enabled = true end
    end
end

-- ربط الاستماع للشات
do
    local ch = CHANNEL or getGeneralChannel()
    if ch and ch.OnIncomingMessage then
        ch.OnIncomingMessage:Connect(function(msg)
            task.spawn(function()
                local ok, err = pcall(function()
                    processChatCommand(msg.TextSource, msg.Text)
                end)
                if not ok then warn(err) end
            end)
        end)
    else
        -- سقوط آمن: لو ما في قناة عامة لأي سبب، ما نكسر اللعب؛ نستمر بدون أوامر شات
        warn("لم يتم العثور على RBXGeneral. أوامر الشات قد لا تعمل.")
    end
end

-------------------------
-- واجهة واحدة ثابتة  --
-------------------------
local function createOrGetUI()
    if _G.__PlayerInfoUI then return _G.__PlayerInfoUI() end

    local pg = localPlayer:WaitForChild("PlayerGui")
    local existing = pg:FindFirstChild("PlayerInfoSettingsPro")
    if existing then
        _G.__PlayerInfoUI = function() return existing end
        return existing
    end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "PlayerInfoSettingsPro"
    screenGui.ResetOnSpawn = false
    screenGui.IgnoreGuiInset = false
    screenGui.Parent = pg

    -- مقياس تلقائي للجوال
    local uiScale = Instance.new("UIScale")
    uiScale.Parent = screenGui
    local function updateScale()
        local s = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
        local minDim = math.min(s.X, s.Y)
        uiScale.Scale = math.clamp(minDim/900, 0.8, 1.1)
    end
    updateScale()
    if workspace.CurrentCamera then
        workspace.CurrentCamera:GetPropertyChangedSignal("ViewportSize"):Connect(updateScale)
    end

    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "Main"
    mainFrame.Size = UDim2.new(0, 540, 0, 440)
    mainFrame.Position = UDim2.new(0.5, -270, 0.5, -220)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, 0, 0, 42)
    title.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    title.BorderSizePixel = 0
    title.Text = "⚙️ إعدادات معلومات اللاعبين (Pro)"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.Parent = mainFrame

    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 40, 0, 42)
    closeBtn.Position = UDim2.new(1, -40, 0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "❌"
    closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 18
    closeBtn.Parent = title
    closeBtn.MouseButton1Click:Connect(function()
        screenGui.Enabled = not screenGui.Enabled
    end)

    local scroll = Instance.new("ScrollingFrame")
    scroll.Size = UDim2.new(1, -20, 1, -105)
    scroll.Position = UDim2.new(0, 10, 0, 50)
    scroll.BackgroundTransparency = 1
    scroll.ScrollBarThickness = 8
    scroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    scroll.Parent = mainFrame

    -- مُصنّع أقسام
    local function section(titleText, y)
        local sec = Instance.new("Frame")
        sec.Size = UDim2.new(1, 0, 0, 150)
        sec.Position = UDim2.new(0, 0, 0, y)
        sec.BackgroundTransparency = 1
        sec.Parent = scroll

        local lbl = Instance.new("TextLabel")
        lbl.Size = UDim2.new(1, 0, 0, 20)
        lbl.BackgroundTransparency = 1
        lbl.Text = titleText
        lbl.TextColor3 = Color3.fromRGB(255, 255, 255)
        lbl.Font = Enum.Font.Gotham
        lbl.TextSize = 14
        lbl.TextXAlignment = Enum.TextXAlignment.Left
        lbl.Parent = sec

        local listFrame = Instance.new("ScrollingFrame")
        listFrame.Name = "List"
        listFrame.Size = UDim2.new(1, -40, 1, -60)
        listFrame.Position = UDim2.new(0, 0, 0, 25)
        listFrame.BackgroundTransparency = 0.1
        listFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
        listFrame.BorderSizePixel = 0
        listFrame.ScrollBarThickness = 6
        listFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
        listFrame.Parent = sec

        local input = Instance.new("TextBox")
        input.Name = "Input"
        input.Size = UDim2.new(1, -40, 0, 30)
        input.Position = UDim2.new(0, 0, 1, -30)
        input.PlaceholderText = "أضف/عدّل..."
        input.ClearTextOnFocus = false
        input.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
        input.BorderSizePixel = 0
        input.TextColor3 = Color3.fromRGB(255, 255, 255)
        input.Font = Enum.Font.Gotham
        input.TextSize = 14
        input.Parent = sec

        local addBtn = Instance.new("TextButton")
        addBtn.Name = "Add"
        addBtn.Size = UDim2.new(0, 30, 0, 30)
        addBtn.Position = UDim2.new(1, -30, 1, -30)
        addBtn.BackgroundColor3 = Color3.fromRGB(60, 160, 60)
        addBtn.BorderSizePixel = 0
        addBtn.Text = "➕"
        addBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
        addBtn.Font = Enum.Font.GothamBold
        addBtn.TextSize = 16
        addBtn.Parent = sec

        return sec, listFrame, input, addBtn
    end

    local traitsSec, traitsList, traitInput, addTraitBtn = section("الصفات (Traits):", 0)
    local typesSec,  typesList,  typeInput,  addTypeBtn  = section("أنواع الشخصيات (Personality):", 160)
    local specialSec,specialList,specialInput,addSpecialBtn= section("الشخصيات الخاصة (Special):", 320)

    scroll.CanvasSize = UDim2.new(0,0,0,480)

    local bottom = Instance.new("Frame")
    bottom.Size = UDim2.new(1, 0, 0, 42)
    bottom.Position = UDim2.new(0, 0, 1, -42)
    bottom.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    bottom.BorderSizePixel = 0
    bottom.Parent = mainFrame

    local showAllBtn = Instance.new("TextButton")
    showAllBtn.Size = UDim2.new(0, 160, 0, 30)
    showAllBtn.Position = UDim2.new(0, 10, 0.5, -15)
    showAllBtn.BackgroundColor3 = Color3.fromRGB(50, 120, 200)
    showAllBtn.BorderSizePixel = 0
    showAllBtn.Text = "📊 عرض جميع اللاعبين"
    showAllBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    showAllBtn.Font = Enum.Font.Gotham
    showAllBtn.TextSize = 14
    showAllBtn.Parent = bottom

    local randomizeBtn = Instance.new("TextButton")
    randomizeBtn.Size = UDim2.new(0, 180, 0, 30)
    randomizeBtn.Position = UDim2.new(0, 180, 0.5, -15)
    randomizeBtn.BackgroundColor3 = Color3.fromRGB(60, 160, 60)
    randomizeBtn.BorderSizePixel = 0
    randomizeBtn.Text = "تحديث معلوماتي"
    randomizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    randomizeBtn.Font = Enum.Font.Gotham
    randomizeBtn.TextSize = 14
    randomizeBtn.Parent = bottom

    local styleLabel = Instance.new("TextLabel")
    styleLabel.Size = UDim2.new(0, 100, 0, 30)
    styleLabel.Position = UDim2.new(1, -210, 0.5, -15)
    styleLabel.BackgroundTransparency = 1
    styleLabel.Text = "نمط العرض:"
    styleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    styleLabel.Font = Enum.Font.Gotham
    styleLabel.TextSize = 14
    styleLabel.Parent = bottom

    local styleBox = Instance.new("TextBox")
    styleBox.Size = UDim2.new(0, 80, 0, 30)
    styleBox.Position = UDim2.new(1, -120, 0.5, -15)
    styleBox.BackgroundColor3 = Color3.fromRGB(45, 45, 45)
    styleBox.BorderSizePixel = 0
    styleBox.Text = tostring(Settings.MessageStyle)
    styleBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    styleBox.Font = Enum.Font.Gotham
    styleBox.TextSize = 14
    styleBox.Parent = bottom

    -- منع التكرار + تحديث القوائم
    local function populateList(listFrame, items, onRemove)
        listFrame:ClearAllChildren()
        local y = 0
        for _, item in ipairs(items) do
            local row = Instance.new("TextButton")
            row.Size = UDim2.new(1, -10, 0, 28)
            row.Position = UDim2.new(0, 5, 0, y)
            row.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            row.BorderSizePixel = 0
            row.TextXAlignment = Enum.TextXAlignment.Left
            row.Text = "  " .. tostring(item)
            row.TextColor3 = Color3.fromRGB(255, 255, 255)
            row.Font = Enum.Font.Gotham
            row.TextSize = 14
            row.Parent = listFrame

            -- حذف بالزر الأيمن
            row.MouseButton2Click:Connect(function()
                for i = #items, 1, -1 do
                    if items[i] == item then
                        table.remove(items, i)
                        break
                    end
                end
                populateList(listFrame, items, onRemove)
                if onRemove then onRemove(item) end
            end)

            y = y + 30
        end
        listFrame.CanvasSize = UDim2.new(0, 0, 0, y)
    end

    local function addUnique(items, value, okMsg, existsMsg)
        value = cleanInput(value)
        if not value then return end
        for _, v in ipairs(items) do
            if v == value then
                safeSend(existsMsg or ("⚠️ موجود مسبقاً: " .. value))
                return
            end
        end
        table.insert(items, value)
        safeSend(okMsg or ("✅ تمت إضافة: " .. value))
    end

    local function refreshAll()
        populateList(traitsList, Settings.Traits, function(item) safeSend("🗑️ حذف الصفة: " .. item) end)
        populateList(typesList, Settings.PersonalityTypes, function(item) safeSend("🗑️ حذف النوع: " .. item) end)
        populateList(specialList, Settings.SpecialCharacters, function(item) safeSend("🗑️ حذف الخاصة: " .. item) end)
    end

    addTraitBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.Traits, traitInput.Text, "✅ تمت إضافة صفة.", "⚠️ الصفة موجودة.")
        traitInput.Text = ""; refreshAll()
    end)
    addTypeBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.PersonalityTypes, typeInput.Text, "✅ تمت إضافة نوع.", "⚠️ النوع موجود.")
        typeInput.Text = ""; refreshAll()
    end)
    addSpecialBtn.MouseButton1Click:Connect(function()
        addUnique(Settings.SpecialCharacters, specialInput.Text, "✅ تمت إضافة شخصية.", "⚠️ الشخصية موجودة.")
        specialInput.Text = ""; refreshAll()
    end)

    showAllBtn.MouseButton1Click:Connect(function()
        local v = tonumber(styleBox.Text)
        if v then Settings.MessageStyle = math.clamp(v,1,10) end
        showAllPlayersInfo(Settings.MessageStyle)
    end)
    randomizeBtn.MouseButton1Click:Connect(function()
        -- إعادة توليد بيانات اللاعب المحلي فقط (حتمي حسب الإعداد)
        PlayerData[localPlayer.UserId] = buildPlayerInfo(localPlayer)
        local v = tonumber(styleBox.Text)
        if v then Settings.MessageStyle = math.clamp(v,1,10) end
        renderPlayerInfo(localPlayer, Settings.MessageStyle)
    end)

    refreshAll()

    _G.__PlayerInfoUI = function() return screenGui end
    return screenGui
end

-- إنشاء الواجهة مرة واحدة
local UI = createOrGetUI()
UI.Enabled = true

--------------------------
-- ربط أحداث اللاعبين  --
--------------------------
Players.PlayerAdded:Connect(function(plr)
    ensurePlayerData(plr)
    task.wait(1)
    if Settings.ShowAllPlayersOnStart then
        renderPlayerInfo(plr, Settings.MessageStyle)
    end
end)

Players.PlayerRemoving:Connect(function(plr)
    PlayerData[plr.UserId] = nil
end)

-----------------
-- تشغيل أولي  --
-----------------
ensurePlayerData(localPlayer)
safeSend("✅ نظام معلومات اللاعبين (Pro) جاهز!")
safeSend("📝 أوامر: !الكل | !نمط [1..10] | !عرض [اسم] | !واجهة")

if Settings.ShowAllPlayersOnStart then
    task.wait(2)
    showAllPlayersInfo(Settings.MessageStyle)
end
